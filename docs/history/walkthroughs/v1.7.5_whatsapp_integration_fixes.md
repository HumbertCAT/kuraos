# WhatsApp Integration Fixes — v1.7.5

## Summary

Fixed three technical debt items in the WhatsApp integration pipeline:
- **TD-115**: MessageLog now supports Lead messages (identity-anchored) ✅
- **TD-116**: Lead→Patient conversion preserves `identity_id` ✅
- **TD-117**: MonitoringTab shows raw messages immediately ✅

---

## TD-115: MessageLog Lead Persistence (Major)

### Problem
Messages from Leads could not be stored because `MessageLog.patient_id` was NOT NULL.

### Solution (Identity-Anchored Design)
Following the Identity Vault pattern (v1.6.4):

render_diffs(file:///Users/humbert/Documents/KuraOS/backend/app/db/models.py)

**Key changes:**
- `patient_id` → nullable
- Added `identity_id` (universal anchor)
- Added `lead_id` (optional Lead reference)

### Migration: `cada03c9385f`

Includes **Point of No Return** warning:
> ⚠️ Downgrade will FAIL if Lead-only messages exist. Manual cleanup required.

### Backfill Script
Created [backfill_messages_identity.py](file:///Users/humbert/Documents/KuraOS/scripts/ops/backfill_messages_identity.py) to populate `identity_id` on existing messages.

---

## TD-116: Identity Preservation

render_diffs(file:///Users/humbert/Documents/KuraOS/backend/app/api/v1/connect/leads.py)

---

## TD-117: Raw Messages Display

render_diffs(file:///Users/humbert/Documents/KuraOS/apps/platform/components/MonitoringTab.tsx)

---

## Commits

| Commit | Description |
|--------|-------------|
| `726601c` | TD-116 + TD-117 fixes |
| `e739cfb` | TD-115 identity-anchored MessageLog |

---

## Production Deployment

1. **Cloud Run**: Run `./scripts/deploy.sh` to apply migration
2. **Backfill**: Execute backfill script on Cloud SQL
3. **Vercel**: Will auto-deploy from GitHub push
