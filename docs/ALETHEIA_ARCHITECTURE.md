# AletheIA Architecture Document

> **For:** Senior Architects  
> **Version:** v1.0.5  
> **Status:** Current Implementation State

---

## 1. Overview

**AletheIA** is Kura OS's clinical intelligence system. The name derives from Greek ἀλήθεια (truth/disclosure) - representing the AI's role in revealing patterns and risks in patient data.

```
┌─────────────────────────────────────────────────────────────────┐
│                    ALETHEIA ECOSYSTEM                           │
├──────────────────┬──────────────────┬───────────────────────────┤
│   INSIGHTS       │   AUTOMATION     │   INTERFACE               │
│   (Analysis)     │   (Agents)       │   (Observatory)           │
├──────────────────┼──────────────────┼───────────────────────────┤
│ • Risk Detection │ • Concierge      │ • Right Sidebar HUD       │
│ • Voice Analysis │ • Ghost Detector │ • Real-time Risk Score    │
│ • Daily Briefing │ • Collector      │ • Active Flags            │
│ • Form Screening │ • Security Shield│ • Biomarkers (Oura)       │
└──────────────────┴──────────────────┴───────────────────────────┘
```

---

## 2. Backend Architecture

### 2.1 AI Provider
| Component | Technology | Model |
|-----------|------------|-------|
| Primary LLM | Google Gen AI SDK | Gemini 2.0 Flash Exp |
| TTS (Briefings) | OpenAI | tts-1 (alloy/nova) |

### 2.2 Key Files
```
backend/app/
├── services/
│   ├── automation_engine.py    # Event-driven agent execution
│   ├── risk_detector.py        # Keyword + sentiment analysis
│   └── stale_journey_monitor.py # Temporal rules (48h ghost detection)
├── workers/
│   └── conversation_analyzer.py # Daily WhatsApp analysis
└── api/v1/
    └── insights.py              # AI analysis endpoints
```

### 2.3 Core Functions

---

#### 2.3.1 Risk Assessment
**File:** `services/risk_detector.py`

Keyword-based risk detection for clinical notes. Flags potential crises.

**Detection Method:**
```python
# Text is scanned for 25+ risk keywords in EN + ES
RISK_KEYWORDS = [
    "suicid*", "quitarme la vida", "matarme",     # Suicidal ideation
    "harm", "autolesion", "cortarme",              # Self-harm
    "crisis", "emergencia", "urgente",             # Crisis
    "morir", "muerte", "quiero morir",             # Death wishes
    "sin esperanza", "hopeless", "sin salida",     # Hopelessness
    "violencia", "pegar", "golpear"                # Violence
]
```

**Output:**
| Level | Condition | Action |
|-------|-----------|--------|
| `HIGH` | Any keyword detected | Alert therapist + block (CENTER tier) |
| `MEDIUM` | Semantic sentiment negative | Dashboard flag |
| `LOW` | No indicators | Silent |

**API Integration:**
- Triggered on `ClinicalEntry.create()` and `FormSubmission.complete()`
- Results stored in `Patient.last_insight_json.risk_level`

---

#### 2.3.2 Engagement Score
**Computed in:** `api/v1/insights.py` → `_generate_fallback_insights()`

0-100 score measuring patient participation and progress.

**Calculation Formula:**
```python
engagement = 50  # Base
if entries: engagement += 20     # Has clinical notes
if bookings: engagement += 15    # Has appointments
if critical_alert: engagement -= 20
if warning_alert: engagement -= 10
# Capped: max(0, min(100, engagement))
```

**UI Display:** Progress bar in AletheiaObservatory with color coding:
- `≥70`: Green (success)
- `40-69`: Amber (warning)  
- `<40`: Red (risk)

---

#### 2.3.3 Thematic Pills
**Generated by:** Gemini Pro (or fallback rules)

Extracted clinical themes from session notes for quick practitioner review.

**Examples:**
| Raw Note Content | Extracted Themes |
|------------------|------------------|
| "El paciente menciona la pérdida de su madre hace 3 meses..." | `["Grief", "Family"]` |
| "Experiencia con psilocibina reportando conexión espiritual..." | `["Spiritual Emergency", "Integration"]` |
| "Paciente bloqueado por contraindicación médica" | `["Bloqueo médico"]` |

**Storage:** `Patient.last_insight_json.themes[]`

**Fallback Themes (when AI unavailable):**
- `"Nuevo paciente"` - No history
- `"Bloqueo médico"` - BLOCKED_MEDICAL status
- `"Estancamiento"` - STAGNATION_ALERT status
- `"Pago pendiente"` - AWAITING_PAYMENT status

---

#### 2.3.4 Daily Briefing
**See Section 4.1** for full documentation.

**Summary:** Audio + text briefing generated at 6AM via Gemini scripting + OpenAI TTS.

---

#### 2.3.5 Lead Stale Monitor
**File:** `workers/stale_journey_monitor.py` → `check_stale_leads()`

Detects leads "going cold" and triggers re-engagement automation.

**Detection Rules:**
```python
# Leads considered stale:
- Status IN (NEW, CONTACTED, QUALIFIED)
- updated_at < NOW - 48 hours
- No LEAD_STAGED_TIMEOUT event in past 24h (anti-spam)
```

**Journey Stale Rules:**
| Journey | Stage | Max Hours | Action |
|---------|-------|-----------|--------|
| `retreat_ibiza_2025` | AWAITING_PAYMENT | 48h | Payment reminder |
| `retreat_ibiza_2025` | POST_RETREAT | 168h (7d) | Satisfaction survey |
| `astrology_luna_llena` | DEEP_DIVE | 336h (14d) | Stagnation alert |
| `yoga_urban_om` | AWAITING_WAIVER | 24h | Waiver reminder |

**Event Emitted:** `LEAD_STAGED_TIMEOUT` → Consumed by "Agente Fantasma"

**Execution:** APScheduler runs `check_stale_leads()` every hour.

---

### 2.4 Processing Pattern
```
1. Ingestion    → Form/Note submitted
2. Queue        → Background task created
3. Analysis     → Gemini Pro processes
4. Caching      → 1-hour intelligent cache
5. Notification → Events emitted to automation engine
```

---

## 3. Database Models

### 3.1 Patient Insights
```python
# Patient.last_insight_json (JSONB)
{
    "risk_level": "HIGH",
    "risk_score": -0.90,
    "themes": ["suicidal_ideation", "sleep_disruption"],
    "engagement": 45,
    "analysis_summary": "...",
    "analyzed_at": "2024-12-25T10:00:00Z"
}

# Patient.last_insight_at (DateTime)
```

### 3.2 AI Usage Tracking
```python
class AiUsageLog:
    organization_id: UUID
    user_id: UUID
    entry_id: Optional[UUID]
    credits_cost: int
    activity_type: str  # "analysis_text", "analysis_audio", "briefing"
    created_at: DateTime
```

### 3.3 Credit System
| Tier | Monthly Quota | Behavior on Exhaustion |
|------|---------------|------------------------|
| BUILDER | 100 | Fail-soft: raw data + "Upgrade Required" |
| PRO | 500 | Same |
| CENTER | 2000 | Same |

---

## 4. Frontend Architecture

### 4.1 Daily Briefing ("Tu Resumen Diario")
**Location:** Dashboard widget + `api/v1/insights.py`

Audio-first summary generated for practitioners each morning.

**Pipeline:**
```
Aggregation → Scripting (Gemini) → Synthesis (OpenAI TTS) → Caching
```

**Data Sources:**
| Source | Content |
|--------|---------|
| Calendar | Today's appointments count |
| Clinical Risk | Patients with `risk_level > MEDIUM` scheduled today |
| Financials | Pending payments (last 24h) |
| CRM | Number of PendingActions awaiting approval |

**Output:**
- **Audio:** MP3 file via OpenAI TTS (`tts-1`, voice: `alloy`/`nova`)
- **Transcript:** Text summary displayed below audio player
- **Caching:** Stored in `static/briefings/` for cost optimization

**API Endpoint:**
```
GET /api/v1/insights/daily-briefing
Response: { audio_url, text_script, generated_at, cached }
```

**UI Component:** Shows play button, "Solo texto disponible" fallback, expandable transcript.

---

### 4.2 AletheiaObservatory Component
**Location:** `components/AletheiaObservatory.tsx`

**Current State:** Dynamic via Zustand store (v1.0.5)

**Visual Elements:**
| Widget | Purpose |
|--------|---------|
| Risk Score | -1.0 to +1.0 gauge with color coding |
| Risk Trend | 72h trend indicator (positive/negative/stable) |
| Voice Analysis | Tone, latency, depression correlation % |
| Biomarkers | HRV (ms), Sleep duration (Oura integration planned) |
| Active Flags | List of detected risk markers |

**Styling:**
- Visible only on `xl` screens (`hidden xl:flex`)
- Width: `w-80` fixed
- Colors: `--ai` (violet), `--risk` (red), `--brand` (teal)
- Typography: `Space Grotesk` for technical headers

### 4.2 Help ChatBot
**Location:** `components/help/HelpChatBot.tsx`

**Features:**
- Platform-specific support grounded in MDX documentation
- Session-aware (user role, tier, current page)
- Query logging to `HelpQueryLog` for topic analysis

---

## 5. Automation Agents

### 5.1 Philosophy: "Agents, Not Tools"
AI is treated as **Active Intelligence** (autonomous teammates) rather than passive software.

### 5.2 Terminology
| Legacy Term | New Term |
|-------------|----------|
| Playbook | Protocolo |
| Install | Activar |
| Marketplace | Catálogo de Agentes |
| Automation | Agente IA |

### 5.3 Active Agents
| Agent | Trigger | Action |
|-------|---------|--------|
| **Concierge** | LEAD_CREATED | Welcome email + booking nudge |
| **Ghost Detector** | LEAD_STAGED_TIMEOUT (48h) | Re-engagement message |
| **Security Shield** | RISK_DETECTED (HIGH) | Block patient (CENTER only) + alert |
| **Collector** | PAYMENT_FAILED | 48h reminder |

### 5.4 Human-in-the-Loop (HITL)
- **Draft Mode:** `agent_config.mode == 'DRAFT_ONLY'`
- **PendingActions Table:** Stores drafted communications
- **Approval Widget:** Dashboard allows View/Edit/Approve/Reject

---

## 6. API Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v1/patients/{id}/insights` | GET | Cached patient insights |
| `/api/v1/patients/{id}/analyze` | POST | Trigger new analysis |
| `/api/v1/clinical-entries/{id}/analyze` | POST | Analyze specific note |
| `/api/v1/admin/trigger-conversation-analysis` | POST | Force daily analysis (superuser) |
| `/api/v1/admin/trigger-cron` | POST | Force stale monitor (superuser) |

---

## 7. Event Types

```python
class EventType(str, Enum):
    FORM_SUBMISSION_COMPLETED = "FORM_SUBMISSION_COMPLETED"
    PAYMENT_SUCCEEDED = "PAYMENT_SUCCEEDED"
    PAYMENT_FAILED = "PAYMENT_FAILED"
    BOOKING_CONFIRMED = "BOOKING_CONFIRMED"
    JOURNEY_STAGE_TIMEOUT = "JOURNEY_STAGE_TIMEOUT"
    RISK_DETECTED_IN_NOTE = "RISK_DETECTED_IN_NOTE"
    LEAD_CREATED = "LEAD_CREATED"
    LEAD_STAGED_TIMEOUT = "LEAD_STAGED_TIMEOUT"
```

---

*Last updated: 2024-12-25*
